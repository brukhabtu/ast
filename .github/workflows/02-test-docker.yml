# ============================================================================
# Test Execution Pipeline
# ============================================================================
# Purpose: Run unit, integration, and e2e tests using the Docker images
# Triggers: After successful Docker build or manual dispatch
# Tests: Executes pytest inside Docker containers for consistent environment
# ============================================================================

name: Run Tests in Docker

on:
  workflow_run:
    workflows: ["Build Docker Image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test'
        required: false
        default: 'main'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  unit-tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Determine image tag
      id: tag
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          # Use the SHA from the workflow that triggered us
          SHA="${{ github.event.workflow_run.head_sha || github.sha }}"
          echo "tag=sha-${SHA:0:8}" >> $GITHUB_OUTPUT
        fi

    - name: Run unit tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} \
          pytest tests/ -m unit -v --tb=short

    - name: Upload unit test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: |
          .coverage
          htmlcov/
          test-results.xml
        retention-days: 30

  integration-tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Determine image tag
      id: tag
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=sha-${{ github.event.workflow_run.head_sha || github.sha }}" | cut -c1-11 >> $GITHUB_OUTPUT
        fi

    - name: Run integration tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} \
          pytest tests/ -m integration -v --tb=short

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          test-results.xml
        retention-days: 30

  e2e-tests:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log in to the Container registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Determine image tag
      id: tag
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=sha-${{ github.event.workflow_run.head_sha || github.sha }}" | cut -c1-11 >> $GITHUB_OUTPUT
        fi

    - name: Setup test repository
      run: |
        # Create a test repository for e2e tests
        mkdir -p test_repos/sample_project
        cd test_repos/sample_project
        cat > sample.py << 'EOF'
        class Calculator:
            def add(self, a, b):
                return a + b
            
            def subtract(self, a, b):
                return a - b
        
        def main():
            calc = Calculator()
            print(calc.add(5, 3))
        
        if __name__ == "__main__":
            main()
        EOF

    - name: Run e2e tests
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }} \
          pytest tests/ -m e2e -v --tb=short

    - name: Upload e2e test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results
        path: |
          test-results.xml
        retention-days: 30

  test-summary:
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: '*-test-results'
        merge-multiple: true

    - name: Generate test summary
      run: |
        echo "## 🧪 Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Test Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Unit Tests**: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Integration Tests**: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **E2E Tests**: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.unit-tests.result }}" == "success" && \
              "${{ needs.integration-tests.result }}" == "success" && \
              "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Some tests failed. Please check the individual test results." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Comment PR with test results (if PR)
      if: github.event.workflow_run.event == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = `## 🧪 Test Results
          
          | Test Type | Status |
          |-----------|--------|
          | Unit Tests | ${{ needs.unit-tests.result }} |
          | Integration Tests | ${{ needs.integration-tests.result }} |
          | E2E Tests | ${{ needs.e2e-tests.result }} |
          
          **Docker Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.event.workflow_run.head_sha }}\`
          `;
          
          // Find the PR number from the workflow run
          const { data: pulls } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
            state: 'open'
          });
          
          if (pulls.length > 0) {
            await github.rest.issues.createComment({
              issue_number: pulls[0].number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          }